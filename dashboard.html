<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard</title>

<style>
  body { 
    font-family: Arial; 
    margin: 0;
    background: #ffffff;
  }

  #contenido {
    display: none;
    margin-top: 30px;
    padding: 20px;
    background: #f0f0f0;
  }

  /* ===== MODAL ===== */
  #modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }

  #modal-box {
    background: white;
    padding: 25px;
    border-radius: 10px;
    text-align: center;
    width: 100%;
    max-width: 400px;
  }

  /* ===== TABLAS ===== */
  .tabla-scroll {
    width: 100%;
    overflow-x: auto;
  }

  table {
    border-collapse: collapse;
    width: 100%;
    min-width: 600px; /* evita que colapsen columnas en tablet */
    margin-top: 15px;
    background: white;
  }

  th, td {
    border: 1px solid #ccc;
    padding: 10px;
    text-align: left;
    height: 48px;
    font-size: 14px;
  }

  th {
    background: #eee;
  }

  /* ===== BOTONES ===== */
  button {
    padding: 8px 12px;
    cursor: pointer;
    margin-right: 5px;
    font-size: 14px;
  }

  .nuevo-btn {
    margin-bottom: 15px;
  }

  /* ===== FILTROS RESPONSIVE ===== */
  #filtros {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 8px;
    margin-bottom: 15px;
  }

  #filtros input {
    padding: 8px;
    font-size: 14px;
  }

  /* ===== CONTENEDOR TABLA + PAGINACION ===== */
  #tabla-container {
    padding: 10px;
    min-height: 460px;
    display: flex;
    flex-direction: column;
  }

  #tabla-destinos {
    flex: 1;
  }

  #paginacion {
    margin-top: 10px;
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
  }

  /* ===== TABLET AJUSTES ===== */
  @media (max-width: 1024px) {

    #contenido {
      padding: 15px;
    }

    h1 {
      font-size: 22px;
    }

    h2 {
      font-size: 18px;
    }

    th, td {
      font-size: 13px;
      padding: 8px;
    }

    button {
      font-size: 13px;
      padding: 7px 10px;
    }

  }

  /* ===== CELULAR ===== */
  @media (max-width: 600px) {

    #contenido {
      margin-top: 10px;
      padding: 12px;
    }

    h1 {
      font-size: 20px;
    }

    h2 {
      font-size: 16px;
    }

    table {
      min-width: 500px;
    }

    button {
      width: 100%;
      margin-right: 0;
    }

    #paginacion {
      justify-content: center;
    }

  }

</style>
</head>
<body>

<div id="modal">
  <div id="modal-box">
    <h3>Ingresar PIN</h3>
    <input type="password" id="pin" style="width:100%; padding:8px;">
    <br><br>
    <button onclick="validar()">Entrar</button>
    <p id="error" style="color:red;"></p>
  </div>
</div>

<div id="contenido">
  <h1>Dashboard</h1>

  <h2>Destinos</h2>
  <button class="nuevo-btn" onclick="window.open('https://docs.google.com/forms/d/e/1FAIpQLSfLOQEkERoS7b55LIoju9FyDpUI7uDwj-Kym3A3Yr5sLosYLQ/viewform?usp=header','_blank')">
    Nuevo destino
  </button>

  <div id="filtros">
    <button onclick="cargarTablaActivos()">Activos</button>
    <button onclick="cargarTablaInactivos()">Inactivos</button>
    <input type="text" id="buscarInput" placeholder="Buscar por nombre" />
    <button onclick="buscarTabla()">Buscar</button>
    <button onclick="refrescarTabla()">Refrescar tabla</button>
  </div>

  <div id="tabla-container">
    <div class="tabla-scroll">
      <div id="tabla-destinos"></div>
    </div>
    <div id="paginacion"></div>
  </div>

  <h2>Tasa de cambio</h2>
  <div class="tabla-scroll">
    <div id="tabla-cambio"></div>
  </div>

</div>

<script>
const URL_SCRIPT = "https://script.google.com/macros/s/AKfycbzheF1cpMWiw5adHj_lrXYHfrmaL9OMixADOatCoT3-ZC0Xd-L-nF29RQdO2lVmNkKQ/exec";
const URL_DESTINOS = "https://script.google.com/macros/s/AKfycbyBtRe25ZSD5jlv7eJ8ExlwDYHpKuA01RK8ToAMA3HuvMklOMDDRuU6wiBRKXkm0fhDOw/exec";
const URL_CAMBIO = "https://script.google.com/macros/s/AKfycbxjq944t-U8WVGm7SiJGGxG43ww2VDRELUbg6Q_GyHPeKGEcMG7zy0NwP3lTE2NVxApmw/exec";

let destinosData = [];
let cambioData = [];
let currentPage = 1;
const rowsPerPage = 5;
let filteredData = [];

window.onload = () => {
  const pinGuardado = localStorage.getItem("pinDashboard");
  if(pinGuardado){
    verificarPin(pinGuardado);
  }
}

function validar() {
  const pin = document.getElementById("pin").value;
  verificarPin(pin);
}

function verificarPin(pin){
  fetch(URL_SCRIPT, {
    method: "POST",
    body: new URLSearchParams({ pin: pin })
  })
  .then(r => r.json())
  .then(data => {
    if (data.ok) {
      localStorage.setItem("pinDashboard", pin);
      document.getElementById("modal").style.display = "none";
      document.getElementById("contenido").style.display = "block";
      refrescarTabla();
    } else {
      document.getElementById("error").innerText = "PIN incorrecto";
      localStorage.removeItem("pinDashboard");
    }
  })
  .catch(() => {
    document.getElementById("error").innerText = "Error de conexi贸n";
  });
}

// Refrescar toda la tabla desde JSON
function refrescarTabla() {
  fetch(URL_DESTINOS).then(r => r.json()).then(data => {
    destinosData = data;
    filteredData = [...destinosData];
    currentPage = 1;
    imprimirTablaPaginada();
  });
  fetch(URL_CAMBIO).then(r => r.json()).then(data => {
    cambioData = data;
    imprimirTablaCambio(cambioData);
  });
}

// Filtrar Activos
function cargarTablaActivos() {
  filteredData = destinosData.filter(f => f.Activo === "true" || f.Activo === true);
  currentPage = 1;
  imprimirTablaPaginada();
}

// Filtrar Inactivos
function cargarTablaInactivos() {
  filteredData = destinosData.filter(f => f.Activo === "false" || f.Activo === false);
  currentPage = 1;
  imprimirTablaPaginada();
}

// Buscar por nombre
function buscarTabla() {
  const val = document.getElementById("buscarInput").value.toLowerCase();
  filteredData = destinosData.filter(f => f.T铆tulo.toLowerCase().includes(val));
  currentPage = 1;
  imprimirTablaPaginada();
}

// Imprimir tabla con paginaci贸n
function imprimirTablaPaginada() {

  if (!Array.isArray(filteredData)) {
    document.getElementById("tabla-destinos").innerHTML = "Sin datos";
    document.getElementById("paginacion").innerHTML = "";
    return;
  }

  const columnas = filteredData.length > 0 ? Object.keys(filteredData[0]) : [];

  const start = (currentPage - 1) * rowsPerPage;
  const end = start + rowsPerPage;
  const pageData = filteredData.slice(start, end);

  let html = "<table><thead><tr>";
  columnas.forEach(col => { if(col !== "editar") html += `<th>${col}</th>`; });
  html += "<th>Acci贸n</th></tr></thead><tbody>";

  // Filas reales
  pageData.forEach(fila => {
    html += "<tr>";
    columnas.forEach(col => { if(col !== "editar") html += `<td>${fila[col]}</td>`; });

    if(fila.editar) {
      const urlForm = `${fila.editar}&entry.1060124700=${encodeURIComponent(fila.editar)}`;
      html += `<td><button onclick="window.open('${urlForm}','_blank')">Editar</button></td>`;
    } else {
      html += "<td>-</td>";
    }

    html += "</tr>";
  });

  //  COMPLETAR HASTA 5 FILAS FIJAS
  const filasVacias = rowsPerPage - pageData.length;
  for (let i = 0; i < filasVacias; i++) {
    html += "<tr>";
    columnas.forEach(col => { if(col !== "editar") html += `<td>&nbsp;</td>`; });
    html += "<td></td>";
    html += "</tr>";
  }

  html += "</tbody></table>";

  document.getElementById("tabla-destinos").innerHTML = html;

  // Paginaci贸n
  const totalPages = Math.ceil(filteredData.length / rowsPerPage) || 1;
  let pagHtml = "";
  for(let i=1;i<=totalPages;i++){
    if(i===currentPage) pagHtml += `<strong>${i}</strong> `;
    else pagHtml += `<button onclick="cambiarPagina(${i})">${i}</button> `;
  }
  document.getElementById("paginacion").innerHTML = pagHtml;
}


// Cambiar p谩gina
function cambiarPagina(page) {
  currentPage = page;
  imprimirTablaPaginada();
}

// Imprimir tabla de cambio
function imprimirTablaCambio(data) {
  if (!Array.isArray(data) || data.length === 0) {
    document.getElementById("tabla-cambio").innerHTML = "Sin datos";
    return;
  }

  const columnas = Object.keys(data[0]);
  let html = "<table><thead><tr>";
  columnas.forEach(col => { if(col !== "editar") html += `<th>${col}</th>`; });
  html += "<th>Acci贸n</th></tr></thead><tbody>";

  data.forEach(fila => {
    html += "<tr>";
    columnas.forEach(col => { if(col !== "editar") html += `<td>${fila[col]}</td>`; });
    if(fila.editar) {
      const urlForm = `${fila.editar}&entry.1060124700=${encodeURIComponent(fila.editar)}`;
      html += `<td><button onclick="window.open('${urlForm}','_blank')">Editar</button></td>`;
    } else {
      html += "<td>-</td>";
    }
    html += "</tr>";
  });

  html += "</tbody></table>";
  document.getElementById("tabla-cambio").innerHTML = html;
}
</script>
</body>
</html>
